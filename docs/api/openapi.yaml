openapi: 3.0.3
info:
  title: JiraLocal API
  description: |
    Local-first JIRA client backend API.

    JiraLocal provides a backend service that acts as a relay/proxy to JIRA servers
    while adding local user management, connection storage, and authentication.

    ## Authentication

    Most endpoints require JWT bearer token authentication. Obtain a token via
    the `/api/auth/login` endpoint and include it in the `Authorization` header:

    ```
    Authorization: Bearer <your_token>
    ```
  version: 0.1.0
  contact:
    name: JiraLocal
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Development server

tags:
  - name: auth
    description: User authentication and registration
  - name: users
    description: User settings and JIRA connection management
  - name: jira-relay
    description: JIRA API proxy/relay endpoints
  - name: health
    description: Health check endpoints

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Returns the health status of the API server.
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy

  /api/auth/register:
    post:
      tags:
        - auth
      summary: Register a new user
      description: Create a new user account with username and password.
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '409':
          description: Username already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/auth/login:
    post:
      tags:
        - auth
      summary: Login and get access token
      description: |
        Authenticate with username and password to receive a JWT access token.
        Uses OAuth2 password flow (form data).
      operationId: login
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: User's username
                password:
                  type: string
                  format: password
                  description: User's password
              required:
                - username
                - password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Token'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/me:
    get:
      tags:
        - auth
      summary: Get current user info
      description: Returns information about the currently authenticated user.
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/connections:
    get:
      tags:
        - users
      summary: List JIRA connections
      description: List all JIRA connections for the current user.
      operationId: listConnections
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of JIRA connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JiraConnectionResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - users
      summary: Create JIRA connection
      description: |
        Create a new JIRA connection. The API token is encrypted before storage.
        If `is_default` is true, any existing default connection will be unset.
      operationId: createConnection
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JiraConnectionCreate'
      responses:
        '201':
          description: Connection created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JiraConnectionResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/users/connections/{connection_id}:
    parameters:
      - name: connection_id
        in: path
        required: true
        description: The unique identifier of the JIRA connection
        schema:
          type: string
          format: uuid

    get:
      tags:
        - users
      summary: Get JIRA connection
      description: Get details of a specific JIRA connection.
      operationId: getConnection
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Connection details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JiraConnectionResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to access this connection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - users
      summary: Update JIRA connection
      description: |
        Update an existing JIRA connection. All fields are optional.
        If `is_default` is set to true, any existing default connection will be unset.
      operationId: updateConnection
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JiraConnectionUpdate'
      responses:
        '200':
          description: Connection updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JiraConnectionResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to modify this connection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    delete:
      tags:
        - users
      summary: Delete JIRA connection
      description: Delete a JIRA connection.
      operationId: deleteConnection
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Connection deleted successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to delete this connection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/jira/{connection_id}/search:
    get:
      tags:
        - jira-relay
      summary: Search JIRA issues
      description: |
        Search for issues using JQL with nextPageToken pagination.
        This is a convenience endpoint that wraps the JIRA search API.
      operationId: searchIssues
      security:
        - bearerAuth: []
      parameters:
        - name: connection_id
          in: path
          required: true
          description: The JIRA connection ID to use
          schema:
            type: string
            format: uuid
        - name: jql
          in: query
          description: JQL query string
          schema:
            type: string
          example: "project = DEMO AND status = Open"
        - name: next_page_token
          in: query
          description: Token for pagination (from previous response)
          schema:
            type: string
        - name: max_results
          in: query
          description: Maximum number of results to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: fields
          in: query
          description: Comma-separated list of fields to return
          schema:
            type: string
          example: "summary,status,assignee"
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResults'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to use this connection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Error communicating with JIRA server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/jira/{connection_id}/issue/{issue_key}:
    get:
      tags:
        - jira-relay
      summary: Get JIRA issue
      description: |
        Get a single issue by its key (e.g., PROJ-123).
        This is a convenience endpoint that wraps the JIRA issue API.
      operationId: getIssue
      security:
        - bearerAuth: []
      parameters:
        - name: connection_id
          in: path
          required: true
          description: The JIRA connection ID to use
          schema:
            type: string
            format: uuid
        - name: issue_key
          in: path
          required: true
          description: The issue key (e.g., PROJ-123)
          schema:
            type: string
          example: DEMO-1
      responses:
        '200':
          description: Issue details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JiraIssue'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized to use this connection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Connection or issue not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Error communicating with JIRA server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/auth/login

  schemas:
    UserCreate:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 100
          description: Unique username
          example: johndoe
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 100
          description: User password (min 8 characters)
          example: secretpassword123

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: 550e8400-e29b-41d4-a716-446655440000
        username:
          type: string
          description: User's username
          example: johndoe
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2024-01-15T10:30:00Z"

    Token:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          default: bearer
          description: Token type (always "bearer")
          example: bearer

    JiraConnectionCreate:
      type: object
      required:
        - name
        - jira_url
        - email
        - api_token
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for this connection
          example: My Company JIRA
        jira_url:
          type: string
          minLength: 1
          maxLength: 500
          description: JIRA server URL (use "demo://local" for mock JIRA)
          example: https://mycompany.atlassian.net
        email:
          type: string
          minLength: 1
          maxLength: 255
          description: Email address for JIRA authentication
          example: user@example.com
        api_token:
          type: string
          minLength: 1
          description: JIRA API token (will be encrypted)
          example: your-api-token-here
        api_version:
          type: integer
          minimum: 2
          maximum: 3
          default: 3
          description: JIRA API version (2 for Server, 3 for Cloud)
          example: 3
        is_default:
          type: boolean
          default: false
          description: Set as default connection

    JiraConnectionUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for this connection
        jira_url:
          type: string
          minLength: 1
          maxLength: 500
          description: JIRA server URL
        email:
          type: string
          minLength: 1
          maxLength: 255
          description: Email address for JIRA authentication
        api_token:
          type: string
          minLength: 1
          description: JIRA API token (will be encrypted)
        api_version:
          type: integer
          minimum: 2
          maximum: 3
          description: JIRA API version (2 for Server, 3 for Cloud)
        is_default:
          type: boolean
          description: Set as default connection

    JiraConnectionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique connection identifier
          example: 550e8400-e29b-41d4-a716-446655440001
        name:
          type: string
          description: Display name
          example: My Company JIRA
        jira_url:
          type: string
          description: JIRA server URL
          example: https://mycompany.atlassian.net
        email:
          type: string
          description: Email used for authentication
          example: user@example.com
        api_version:
          type: integer
          description: JIRA API version
          example: 3
        is_default:
          type: boolean
          description: Whether this is the default connection
          example: true
        created_at:
          type: string
          format: date-time
          description: Connection creation timestamp
          example: "2024-01-15T10:30:00Z"

    SearchResults:
      type: object
      properties:
        issues:
          type: array
          items:
            $ref: '#/components/schemas/JiraIssue'
          description: List of matching issues
        total:
          type: integer
          description: Total number of matching issues
          example: 42
        maxResults:
          type: integer
          description: Maximum results per page
          example: 50
        nextPageToken:
          type: string
          nullable: true
          description: Token for fetching next page (null if no more pages)

    JiraIssue:
      type: object
      description: JIRA issue object (structure varies based on JIRA configuration)
      properties:
        id:
          type: string
          description: Issue ID
          example: "10001"
        key:
          type: string
          description: Issue key
          example: DEMO-1
        self:
          type: string
          description: API URL for this issue
        fields:
          type: object
          description: Issue fields (varies based on JIRA project configuration)
          properties:
            summary:
              type: string
              description: Issue summary/title
            description:
              type: string
              nullable: true
              description: Issue description
            status:
              type: object
              properties:
                name:
                  type: string
                  example: Open
            assignee:
              type: object
              nullable: true
              properties:
                displayName:
                  type: string
            reporter:
              type: object
              properties:
                displayName:
                  type: string
            created:
              type: string
              format: date-time
            updated:
              type: string
              format: date-time

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          description: Error message
          example: Connection not found

    ValidationError:
      type: object
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
                description: Location of the error
              msg:
                type: string
                description: Error message
              type:
                type: string
                description: Error type
